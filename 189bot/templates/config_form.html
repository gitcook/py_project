<!DOCTYPE html>
<html>
<head>
    <title>äº‘ç›˜ç›‘æ§é…ç½®</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: sans-serif;
            max-width: 900px;
            margin: auto;
            padding: 20px;
            background-color: #f4f7f6;
        }
        h1 {
            color: #007bff;
            font-size: 1.6em;
        }
        fieldset {
            margin-bottom: 25px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 10px;
            background-color: #fff;
        }
        legend {
            font-weight: bold;
            padding: 0 10px;
            color: #007bff;
        }
        label {
            font-weight: 500;
            color: #555;
            white-space: nowrap;
            text-align: right;
            padding-right: 10px;
        }
        input[type="text"], input[type="password"], input[type="number"], textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            max-width: 100%;
        }
        textarea {
            height: 80px;
            resize: vertical;
            font-family: monospace;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .button-group button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .save-btn { background-color: #4CAF50; color: white; }
        .save-btn:hover { background-color: #45a049; }
        .start-btn { background-color: #007bff; color: white; }
        .start-btn:hover { background-color: #0056b3; }
        .stop-btn { background-color: #dc3545; color: white; }
        .stop-btn:hover { background-color: #c82333; }
        .button-group button:disabled { opacity: 0.6; cursor: not-allowed; }
        #status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }
        .running { color: white; background-color: #28a745; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; }
        .stopped { color: white; background-color: #6c757d; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; }

        /* è¡¨å•è¡Œ Grid å¸ƒå±€ */
        .form-row {
            display: grid;
            grid-template-columns: 150px 1fr 150px 1fr;
            gap: 12px;
            align-items: center;
            margin-top: 10px;
        }

        .form-row-full {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 12px;
            align-items: start;
            margin-top: 10px;
        }

        /* è§„åˆ™åŒºåŸŸ Grid å¸ƒå±€ï¼Œæ¯è¡Œä¸¤ä¸ª textarea */
        .rule-textarea-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }
        .rule-textarea-item {
            display: flex;
            flex-direction: column;
        }
        .rule-textarea-item label {
	    text-align: center; /* æ°´å¹³å±…ä¸­ */
            margin-bottom: 5px;
       /*     font-weight: 500;
            margin-bottom: 4px;*/
        }
        .rule-textarea-item textarea {
            width: 100%;
            height: 80px;
            resize: vertical;
        }

        .rule-block {
            border: 1px dashed #007bff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #f8faff;
        }
        .rule-block h4 {
            margin-top: 0;
            color: #007bff;
        }
        .rule-block button {
            background-color: #dc3545;
            color: white;
            margin-top: 10px;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .rule-block button:hover { background-color: #c82333; }

        .add-rule-btn {
            background-color: #28a745;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        .add-rule-btn:hover { background-color: #218838; }

        @media(max-width:700px){
            .form-row, .form-row-full, .rule-textarea-grid {
                grid-template-columns: 1fr; /* å°å±å¹•å †å  */
            }
            label { text-align: left; padding-right: 0; }
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– Alist-TVBox ç›‘æ§é…ç½®</h1>

    <p>å½“å‰è¿è¡ŒçŠ¶æ€: 
        {% if is_running %}
            <span class="running">ğŸŸ¢ è¿è¡Œä¸­</span>
        {% else %}
            <span class="stopped">ğŸ”´ æœªè¿è¡Œ</span>
        {% endif %}
    </p>

    <div class="button-group">
        <button class="start-btn" onclick="startMonitor()" {% if is_running %}disabled{% endif %}>å¯åŠ¨ç›‘æ§</button>
        <button class="stop-btn" onclick="stopMonitor()" {% if not is_running %}disabled{% endif %}>åœæ­¢ç›‘æ§</button>
    </div>

    <form id="configForm">
        <!-- Telegram é…ç½® -->
        <fieldset>
            <legend>1. Telegram é…ç½®</legend>
            <div class="form-row">
                <label>API ID:</label><input type="number" name="API_ID" value="{{ config.TELEGRAM.API_ID }}" required>
                <label>API Hash:</label><input type="password" name="API_HASH" value="{{ config.TELEGRAM.API_HASH }}" required>
            </div>
            <div class="form-row-full">
                <label>Session:</label><input type="password" name="STRING_SESSION" value="{{ config.TELEGRAM.STRING_SESSION }}" placeholder="å¡«ä½ è‡ªå·±çš„tg session" required>
            </div>
        </fieldset>

        <!-- Alist-TVBox é…ç½® -->
        <fieldset>
            <legend>2. Alist-TVBox æ¥å£é…ç½®</legend>
            <div class="form-row">
                <label>ALIST URL:</label><input type="text" name="ALIST_URL" value="{{ config.ALIST.URL }}" placeholder="http://192.168.2.1:4567/api/shares/" required>
                <label>ALIST Key:</label><input type="password" name="ALIST_KEY" value="{{ config.ALIST.KEY }}" required>
            </div>
        </fieldset>

        <!-- è¿è¡Œç¯å¢ƒä¸æ‰«æé…ç½® -->
        <fieldset>
            <legend>3. è¿è¡Œç¯å¢ƒä¸æ‰«æé…ç½®</legend>
            <div class="form-row">
                <label>è¿è¡Œæ¨¡å¼:</label><input type="number" name="LOOP_SWITCH" value="{{ config.MONITORING.LOOP_SWITCH }}" placeholder="1 = å¾ªç¯ç›‘æ§(å¸¸é©»), 2 = å•æ¬¡è¿è¡Œ(è·‘å®Œé€€å‡º)" required>
                <label>å¾ªç¯é—´éš”(å°æ—¶):</label><input type="number" name="MONITOR_INTERVAL_HOURS" value="{{ config.MONITORING.MONITOR_INTERVAL_HOURS }}" required>
            </div>
            <div class="form-row">
                <label>ç›‘æ§æ¶ˆæ¯ä¸Šé™:</label><input type="number" name="MONITOR_LIMIT" value="{{ config.MONITORING.MONITOR_LIMIT }}" required>
                <label>æœ€å¤§å›æº¯å¤©æ•°:</label><input type="number" name="MONITOR_DAYS" value="{{ config.MONITORING.MONITOR_DAYS }}" required>
            </div>
            <div class="form-row">
                <label>æ™ºèƒ½ä¸­æ–­è®¡æ•°:</label><input type="number" name="SMART_STOP_COUNT" value="{{ config.MONITORING.SMART_STOP_COUNT }}" required>
                <label>æ•°æ®è®°å½•ä¿ç•™å¤©æ•°:</label><input type="number" name="DB_RETENTION_DAYS" value="{{ config.MONITORING.DB_RETENTION_DAYS }}" required>
            </div>
            <div class="form-row-full">
                <label>ç›‘æ§é¢‘é“åˆ—è¡¨:</label>
                <textarea name="CHANNEL_URLS">{{ '\n'.join(config.MONITORING.CHANNEL_URLS) }}</textarea>
            </div>
        </fieldset>

        <!-- æŠ“å–å¼€å…³ -->
        <fieldset>
            <legend>4. æŠ“å–å¼€å…³</legend>
            <div class="form-row">
                <label><input type="checkbox" name="ENABLE_189" {% if config.DRIVE_SWITCHES.ENABLE_189 %}checked{% endif %}>189</label>
                <label><input type="checkbox" name="ENABLE_UC" {% if config.DRIVE_SWITCHES.ENABLE_UC %}checked{% endif %}>UC</label>
            </div>
            <div class="form-row">
                <label><input type="checkbox" name="ENABLE_123" {% if config.DRIVE_SWITCHES.ENABLE_123 %}checked{% endif %}>123</label>
                <label><input type="checkbox" name="ENABLE_115" {% if config.DRIVE_SWITCHES.ENABLE_115 %}checked{% endif %}>115</label>
            </div>
            <div class="form-row">
                <label><input type="checkbox" name="ENABLE_QUARK" {% if config.DRIVE_SWITCHES.ENABLE_QUARK %}checked{% endif %}>QUARK</label>
            </div>
        </fieldset>

        <!-- å…¨å±€è¿‡æ»¤å…³é”®è¯ -->
        <fieldset>
            <legend>5. å…¨å±€è¿‡æ»¤å…³é”®è¯</legend>
            <div class="form-row-full">
                <label>å…³é”®è¯:</label>
                <textarea name="EXCLUDE_KEYWORDS">{{ '\n'.join(config.FILTERING.EXCLUDE_KEYWORDS) }}</textarea>
            </div>
        </fieldset>

        <!-- ç›‘æ§åˆ†ç±»è§„åˆ™ -->
        <fieldset>
            <legend>6. ç›‘æ§åˆ†ç±»è§„åˆ™ (API_CONFIGS)</legend>
            <div id="rulesContainer"></div>
            <button class="add-rule-btn" type="button" onclick="addRule()">+ æ·»åŠ æ–°è§„åˆ™</button>
        </fieldset>

    <div class="button-group">
        <button class="start-btn" type="submit"> ä¿å­˜é…ç½®</button>
    </div>
    </form>

    <p id="status"></p>

    <script>
        const initialRules = {{ config.RULES.API_CONFIGS | tojson }};
        let nextRuleIndex = initialRules.length;

        function getRuleHtml(index, rule){
            const priorityStr = (rule.priority_keywords ? rule.priority_keywords.join('\n') : '');
            const requiredStr = (rule.required_keywords ? rule.required_keywords.join('\n') : '');
            const optionalStr = (rule.optional_keywords ? rule.optional_keywords.join('\n') : '');
            const excludedStr = (rule.excluded_keywords ? rule.excluded_keywords.join('\n') : '');

            return `
            <div class="rule-block" id="rule-${index}">
                <h4>è§„åˆ™ ${index+1}: ${rule.name || 'æ–°è§„åˆ™'}</h4>
                <div class="form-row">
                    <label>è§„åˆ™åç§°:</label><input type="text" name="RULES[${index}][name]" value="${rule.name||''}" required>
                    <label>ä¿å­˜è·¯å¾„å‰ç¼€:</label><input type="text" name="RULES[${index}][folder_prefix]" value="${rule.folder_prefix||''}" required>
                </div>
                <div class="rule-textarea-grid">
                    <div class="rule-textarea-item">
                        <label>ç‰¹æƒå…³é”®è¯:</label>
                        <textarea name="RULES[${index}][priority_keywords]">${priorityStr}</textarea>
                    </div>
                    <div class="rule-textarea-item">
                        <label>å¿…é€‰å…³é”®è¯:</label>
                        <textarea name="RULES[${index}][required_keywords]">${requiredStr}</textarea>
                    </div>
                    <div class="rule-textarea-item">
                        <label>å¯é€‰å…³é”®è¯:</label>
                        <textarea name="RULES[${index}][optional_keywords]">${optionalStr}</textarea>
                    </div>
                    <div class="rule-textarea-item">
                        <label>æ’é™¤å…³é”®è¯:</label>
                        <textarea name="RULES[${index}][excluded_keywords]">${excludedStr}</textarea>
                    </div>
                </div>
                <button type="button" onclick="removeRule(${index})">åˆ é™¤æ­¤è§„åˆ™</button>
            </div>`;
        }

        function renderRules(){
            const container = document.getElementById('rulesContainer');
            container.innerHTML = '';
            initialRules.forEach((rule,index)=>container.insertAdjacentHTML('beforeend',getRuleHtml(index,rule)));
            nextRuleIndex = initialRules.length;
        }

        function addRule(){
            const newRule = {name:`æ–°è§„åˆ™ ${nextRuleIndex+1}`,folder_prefix:"",priority_keywords:[],required_keywords:[],optional_keywords:[],excluded_keywords:[]};
            document.getElementById('rulesContainer').insertAdjacentHTML('beforeend',getRuleHtml(nextRuleIndex,newRule));
            nextRuleIndex++;
        }

        function removeRule(index){document.getElementById(`rule-${index}`).remove();}
        document.addEventListener('DOMContentLoaded', renderRules);

        async function sendApiRequest(endpoint, method, body=null){
            const res = await fetch(endpoint,{method,headers:{'Content-Type':'application/json'},body:body?JSON.stringify(body):null});
            return res.json();
        }

        document.getElementById('configForm').addEventListener('submit', async function(e){
            e.preventDefault();
            const formData = new FormData(e.target);
            const data={TELEGRAM:{},ALIST:{},MONITORING:{},DRIVE_SWITCHES:{},FILTERING:{},RULES:{API_CONFIGS:[]},PROXY:{}};
            data.TELEGRAM.API_ID=formData.get('API_ID');
            data.TELEGRAM.API_HASH=formData.get('API_HASH');
            data.TELEGRAM.STRING_SESSION=formData.get('STRING_SESSION');
            data.ALIST.URL=formData.get('ALIST_URL');
            data.ALIST.KEY=formData.get('ALIST_KEY');
            data.MONITORING.SAVE_PATH=formData.get('SAVE_PATH');
            data.MONITORING.LOOP_SWITCH=formData.get('LOOP_SWITCH');
            data.MONITORING.MONITOR_INTERVAL_HOURS=formData.get('MONITOR_INTERVAL_HOURS');
            data.MONITORING.MONITOR_LIMIT=formData.get('MONITOR_LIMIT');
            data.MONITORING.MONITOR_DAYS=formData.get('MONITOR_DAYS');
            data.MONITORING.SMART_STOP_COUNT=formData.get('SMART_STOP_COUNT');
            data.MONITORING.DB_RETENTION_DAYS=formData.get('DB_RETENTION_DAYS');
            data.MONITORING.CHANNEL_URLS_TEXT=formData.get('CHANNEL_URLS');
            data.DRIVE_SWITCHES.ENABLE_189=formData.get('ENABLE_189')==='on';
            data.DRIVE_SWITCHES.ENABLE_UC=formData.get('ENABLE_UC')==='on';
            data.DRIVE_SWITCHES.ENABLE_123=formData.get('ENABLE_123')==='on';
            data.DRIVE_SWITCHES.ENABLE_115=formData.get('ENABLE_115')==='on';
            data.FILTERING.EXCLUDE_KEYWORDS_TEXT=formData.get('EXCLUDE_KEYWORDS');
            data.PROXY.ENABLE_PROXY={{ config.PROXY.ENABLE_PROXY | tojson }};
            data.PROXY.PROXY_URL={{ config.PROXY.PROXY_URL | tojson }};
            document.querySelectorAll('.rule-block').forEach(block=>{
                const ruleData={
                    name:block.querySelector('input[name$="[name]"]').value,
                    folder_prefix:block.querySelector('input[name$="[folder_prefix]"]').value,
                    priority_keywords_text:block.querySelector('textarea[name$="[priority_keywords]"]').value,
                    required_keywords_text:block.querySelector('textarea[name$="[required_keywords]"]').value,
                    optional_keywords_text:block.querySelector('textarea[name$="[optional_keywords]"]').value,
                    excluded_keywords_text:block.querySelector('textarea[name$="[excluded_keywords]"]').value
                };
                data.RULES.API_CONFIGS.push(ruleData);
            });
            const result = await sendApiRequest('/api/config','POST',data);
            document.getElementById('status').innerHTML=result.message+(result.success?'':'<br>è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ã€‚');
            if(result.success){ setTimeout(()=>location.reload(),500);}
        });

        async function startMonitor(){
            const result = await sendApiRequest('/api/monitor/start','POST');
            document.getElementById('status').textContent=result.message;
            if(result.success){ setTimeout(()=>location.reload(),1000);}
        }
        async function stopMonitor(){
            const result = await sendApiRequest('/api/monitor/stop','POST');
            document.getElementById('status').textContent=result.message;
            if(result.success){ setTimeout(()=>location.reload(),1000);}
        }

    </script>
</body>
</html>

