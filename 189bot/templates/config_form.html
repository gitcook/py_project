<!DOCTYPE html>
<html>
<head>
    <title>äº‘ç›˜ç›‘æ§é…ç½®</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 20px; background-color: #f4f7f6; }
        h1 { color: #333; }
        fieldset { margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; background-color: white; }
        legend { font-weight: bold; padding: 0 10px; color: #007bff; }
        label { display: block; margin-top: 10px; font-weight: 500; color: #555; }
        input[type="text"], input[type="password"], input[type="number"], textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px; }
        textarea { height: 80px; resize: vertical; font-family: monospace; }
        .button-group button { padding: 10px 15px; margin-right: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .save-btn { background-color: #4CAF50; color: white; }
        .save-btn:hover { background-color: #45a049; }
        .start-btn { background-color: #007bff; color: white; }
        .start-btn:hover { background-color: #0056b3; }
        .stop-btn { background-color: #dc3545; color: white; }
        .stop-btn:hover { background-color: #c82333; }
        .button-group button:disabled { opacity: 0.6; cursor: not-allowed; }
        #status { margin-top: 15px; padding: 10px; border-radius: 5px; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; }
        .running { color: white; background-color: #28a745; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; }
        .stopped { color: white; background-color: #6c757d; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; }
        .rule-block { border: 1px dashed #007bff; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #f8faff; }
        .rule-block h4 { margin-top: 0; color: #007bff; }
        .rule-block button { background-color: #dc3545; color: white; margin-top: 10px;}
        .rule-block button:hover { background-color: #c82333; }
        .add-rule-btn { background-color: #28a745; color: white; }
        .add-rule-btn:hover { background-color: #218838; }
        input[type="checkbox"] { width: auto; margin-left: 0; }
    </style>
</head>
<body>
    <h1>ğŸ¤– Alist-TVBox ç›‘æ§é…ç½®</h1>
    <p>å½“å‰è¿è¡ŒçŠ¶æ€: 
        {% if is_running %}
            <span class="running">ğŸŸ¢ è¿è¡Œä¸­</span>
        {% else %}
            <span class="stopped">ğŸ”´ æœªè¿è¡Œ</span>
        {% endif %}
    </p>

    <div class="button-group">
        <button class="start-btn" onclick="startMonitor()" {% if is_running %}disabled{% endif %}>å¯åŠ¨ç›‘æ§</button>
        <button class="stop-btn" onclick="stopMonitor()" {% if not is_running %}disabled{% endif %}>åœæ­¢ç›‘æ§</button>
    </div>
    
    <hr>

    <form id="configForm">
        <fieldset>
            <legend>1. Telegram é…ç½®</legend>
            <label>API ID:</label><input type="number" name="API_ID" value="{{ config.TELEGRAM.API_ID }}" required><br>
            <label>API Hash:</label><input type="password" name="API_HASH" value="{{ config.TELEGRAM.API_HASH }}" required><br>
            <label>Session (String):</label><input type="text" name="STRING_SESSION" value="{{ config.TELEGRAM.STRING_SESSION }}" placeholder="å¡«ä½ è‡ªå·±çš„tg session" required><br>
        </fieldset>
        
        <fieldset>
            <legend>2. Alist-TVBox æ¥å£é…ç½®</legend>
            <label>ALIST URL (API æ¥å£åœ°å€):</label><input type="text" name="ALIST_URL" value="{{ config.ALIST.URL }}" placeholder="http://192.168.2.1:4567/api/shares/" required><br>
            <label>ALIST Key (API å¯†é’¥):</label><input type="password" name="ALIST_KEY" value="{{ config.ALIST.KEY }}" required><br>
        </fieldset>

        <fieldset>
            <legend>3. è¿è¡Œç¯å¢ƒä¸æ‰«æé…ç½®</legend>
            <label>æ•°æ®ä¿å­˜è·¯å¾„ (Docker å†…éƒ¨):</label><input type="text" name="SAVE_PATH" value="{{ config.MONITORING.SAVE_PATH }}" readonly title="Dockerå†…éƒ¨è·¯å¾„ï¼Œè¯·å‹¿ä¿®æ”¹"><br>
            <label>è¿è¡Œæ¨¡å¼ (1=å¾ªç¯å¸¸é©», 2=å•æ¬¡è¿è¡Œ):</label><input type="number" name="LOOP_SWITCH" value="{{ config.MONITORING.LOOP_SWITCH }}" required><br>
            <label>å¾ªç¯é—´éš” (å°æ—¶):</label><input type="number" name="MONITOR_INTERVAL_HOURS" value="{{ config.MONITORING.MONITOR_INTERVAL_HOURS }}" required><br>
            
            <hr>
            
            <label>ç›‘æ§æ¶ˆæ¯ä¸Šé™ (MONITOR_LIMIT):</label>
            <input type="number" name="MONITOR_LIMIT" value="{{ config.MONITORING.MONITOR_LIMIT }}" required><br>

            <label>æœ€å¤§å›æº¯å¤©æ•° (MONITOR_DAYS):</label>
            <input type="number" name="MONITOR_DAYS" value="{{ config.MONITORING.MONITOR_DAYS }}" required><br>

            <label>æ™ºèƒ½ä¸­æ–­è®¡æ•° (SMART_STOP_COUNT):</label>
            <input type="number" name="SMART_STOP_COUNT" value="{{ config.MONITORING.SMART_STOP_COUNT }}" required><br>

            <label>æ•°æ®åº“è®°å½•ä¿ç•™å¤©æ•° (DB_RETENTION_DAYS):</label>
            <input type="number" name="DB_RETENTION_DAYS" value="{{ config.MONITORING.DB_RETENTION_DAYS }}" required><br>
            <hr>
            
            <label>ç›‘æ§é¢‘é“åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ªé“¾æ¥):</label>
            <textarea name="CHANNEL_URLS">{{ '\n'.join(config.MONITORING.CHANNEL_URLS) }}</textarea>
        </fieldset>

        <fieldset>
            <legend>4. æŠ“å–å¼€å…³</legend>
            <label><input type="checkbox" name="ENABLE_189" {% if config.DRIVE_SWITCHES.ENABLE_189 %}checked{% endif %}> å¯ç”¨ å¤©ç¿¼äº‘ç›˜ (189)</label><br>
            <label><input type="checkbox" name="ENABLE_UC" {% if config.DRIVE_SWITCHES.ENABLE_UC %}checked{% endif %}> å¯ç”¨ UC ç½‘ç›˜</label><br>
            <label><input type="checkbox" name="ENABLE_123" {% if config.DRIVE_SWITCHES.ENABLE_123 %}checked{% endif %}> å¯ç”¨ 123 ç½‘ç›˜</label>
        </fieldset>

        <fieldset>
            <legend>5. å…¨å±€è¿‡æ»¤å…³é”®è¯</legend>
            <label>EXCLUDE_KEYWORDS (å…¨å±€æ’é™¤è¯ï¼Œæ¯è¡Œä¸€ä¸ª):</label>
            <textarea name="EXCLUDE_KEYWORDS">{{ '\n'.join(config.FILTERING.EXCLUDE_KEYWORDS) }}</textarea>
        </fieldset>
        
        <fieldset>
            <legend>6. ç›‘æ§åˆ†ç±»è§„åˆ™ (API_CONFIGS)</legend>
            <div id="rulesContainer">
            </div>
            <button class="add-rule-btn" type="button" onclick="addRule()">+ æ·»åŠ æ–°è§„åˆ™</button>
        </fieldset>
        
        <button class="save-btn" type="submit">ğŸ’¾ ä¿å­˜é…ç½®</button>
    </form>
    
    <p id="status"></p>

    <script>
        // ä» Flask æ³¨å…¥çš„é…ç½®å¯¹è±¡ä¸­åŠ è½½è§„åˆ™
        const initialRules = {{ config.RULES.API_CONFIGS | tojson }};
        let nextRuleIndex = initialRules.length;

        async function sendApiRequest(endpoint, method, body = null) {
            const response = await fetch(endpoint, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: body ? JSON.stringify(body) : null
            });
            return response.json();
        }

        // --- è§„åˆ™åŠ¨æ€æ¸²æŸ“å’Œç®¡ç† ---
        function getRuleHtml(index, rule) {
            // âœ… å…³é”®ä¿®æ­£ï¼šä½¿ç”¨ (rule.field ? rule.field.join('\n') : '') ç¡®ä¿å³ä½¿å­—æ®µä¸ºç©ºæˆ–æœªå®šä¹‰ä¹Ÿä¸ä¼šæŠ¥é”™
            const priorityKeywordsStr = (rule.priority_keywords ? rule.priority_keywords.join('\n') : '');
            const requiredKeywordsStr = (rule.required_keywords ? rule.required_keywords.join('\n') : ''); 
            const optionalKeywordsStr = (rule.optional_keywords ? rule.optional_keywords.join('\n') : '');
            const excludedKeywordsStr = (rule.excluded_keywords ? rule.excluded_keywords.join('\n') : '');

            return `
                <div class="rule-block" id="rule-${index}">
                    <h4>è§„åˆ™ ${index + 1}: ${rule.name || 'æ–°è§„åˆ™'}</h4>
                    <label>è§„åˆ™åç§° (name):</label><input type="text" name="RULES[${index}][name]" value="${rule.name || ''}" required><br>
                    <label>ä¿å­˜è·¯å¾„å‰ç¼€ (folder_prefix):</label><input type="text" name="RULES[${index}][folder_prefix]" value="${rule.folder_prefix || ''}" required><br>
                    
                    <label>ç‰¹æƒå…³é”®è¯ (æ¯è¡Œä¸€ä¸ª,å¤šèµ„æºè®¢é˜…):</label>
                    <textarea name="RULES[${index}][priority_keywords]">${priorityKeywordsStr}</textarea>
                    
                    <label>å¿…é€‰å…³é”®è¯ï¼ˆAND åŒ¹é…ï¼Œå•ç‹¬ä¸€ä¸ªèµ„æºï¼‰:</label>
                    <textarea name="RULES[${index}][required_keywords]">${requiredKeywordsStr}</textarea>

                    <label>å¯é€‰å…³é”®è¯ (æ¯è¡Œä¸€ä¸ª):</label>
                    <textarea name="RULES[${index}][optional_keywords]">${optionalKeywordsStr}</textarea>

                    <label>æ’é™¤å…³é”®è¯ (æ¯è¡Œä¸€ä¸ª):</label>
                    <textarea name="RULES[${index}][excluded_keywords]">${excludedKeywordsStr}</textarea>

                    <label><input type="checkbox" name="RULES[${index}][try_join]" ${rule.try_join ? 'checked' : ''}> å°è¯•åŠ å…¥é¢‘é“ (try_join)</label><br>
                    
                    <button type="button" onclick="removeRule(${index})">åˆ é™¤æ­¤è§„åˆ™</button>
                </div>
            `;
        }

        function renderRules() {
            const container = document.getElementById('rulesContainer');
            container.innerHTML = '';
            
            // ä½¿ç”¨ initialRules çš„å†…å®¹é‡æ–°æ¸²æŸ“ï¼Œç¡®ä¿åŠ è½½çš„æ˜¯ config.json çš„æ•°æ®
            initialRules.forEach((rule, index) => {
                // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨æ•°ç»„ç´¢å¼•ä½œä¸ºè§„åˆ™çš„å”¯ä¸€æ ‡è¯†
                container.insertAdjacentHTML('beforeend', getRuleHtml(index, rule));
            });
            nextRuleIndex = initialRules.length;
        }

        function addRule() {
            const newRule = {
                name: `æ–°è§„åˆ™ ${nextRuleIndex + 1}`,
                folder_prefix: "",
                priority_keywords: [],
                required_keywords: [], 
                optional_keywords: [],
                excluded_keywords: [],
                try_join: true
            };
            const container = document.getElementById('rulesContainer');
            container.insertAdjacentHTML('beforeend', getRuleHtml(nextRuleIndex, newRule));
            nextRuleIndex++;
        }

        function removeRule(index) {
            const element = document.getElementById(`rule-${index}`);
            if (element) {
                element.remove();
                // æ³¨æ„: å°½ç®¡DOMå…ƒç´ è¢«ç§»é™¤ï¼Œä½†ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ä¾èµ–äºæäº¤æ—¶é‡æ–°æ”¶é›†æ‰€æœ‰ç°å­˜çš„ .rule-block
            }
        }
        
        document.addEventListener('DOMContentLoaded', renderRules);

        // --- æäº¤å‡½æ•° (æœ€é‡è¦!) ---
        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                TELEGRAM: {}, ALIST: {}, MONITORING: {}, DRIVE_SWITCHES: {}, FILTERING: {}, RULES: { API_CONFIGS: [] }, PROXY: {}
            };
            
            // åŸºç¡€é…ç½®æ”¶é›†
            data.TELEGRAM.API_ID = formData.get('API_ID');
            data.TELEGRAM.API_HASH = formData.get('API_HASH');
            data.TELEGRAM.STRING_SESSION = formData.get('STRING_SESSION');
            
            data.ALIST.URL = formData.get('ALIST_URL');
            data.ALIST.KEY = formData.get('ALIST_KEY');
            
            // â— MONITORING é…ç½®æ”¶é›† (åŒ…å«æ‰€æœ‰æ–°çš„æ‰«æå‚æ•°)
            data.MONITORING.SAVE_PATH = formData.get('SAVE_PATH');
            data.MONITORING.LOOP_SWITCH = formData.get('LOOP_SWITCH');
            data.MONITORING.MONITOR_INTERVAL_HOURS = formData.get('MONITOR_INTERVAL_HOURS');
            
            // å…¨å±€æ‰«æå‚æ•° (å·²åŒ…å«åœ¨ form data ä¸­)
            data.MONITORING.MONITOR_LIMIT = formData.get('MONITOR_LIMIT');
            data.MONITORING.MONITOR_DAYS = formData.get('MONITOR_DAYS');
            data.MONITORING.SMART_STOP_COUNT = formData.get('SMART_STOP_COUNT');
            data.MONITORING.DB_RETENTION_DAYS = formData.get('DB_RETENTION_DAYS'); 

            // é¢‘é“åˆ—è¡¨ (ä½¿ç”¨ _TEXT å­—æ®µå)
            data.MONITORING.CHANNEL_URLS_TEXT = formData.get('CHANNEL_URLS'); 
            
            // å¼€å…³ (å¤„ç†æœªè¢«é€‰ä¸­çš„æƒ…å†µ)
            data.DRIVE_SWITCHES.ENABLE_189 = formData.get('ENABLE_189') === 'on';
            data.DRIVE_SWITCHES.ENABLE_UC = formData.get('ENABLE_UC') === 'on';
            data.DRIVE_SWITCHES.ENABLE_123 = formData.get('ENABLE_123') === 'on';

            // è¿‡æ»¤è¯ (ä½¿ç”¨ _TEXT å­—æ®µå)
            data.FILTERING.EXCLUDE_KEYWORDS_TEXT = formData.get('EXCLUDE_KEYWORDS');

            // ä»£ç† (ä¿ç•™é…ç½®ä¸­æœªåœ¨å‰ç«¯æ˜¾ç¤ºçš„å­—æ®µï¼Œç¡®ä¿ä¸ä¸¢å¤±)
            data.PROXY.ENABLE_PROXY = {{ config.PROXY.ENABLE_PROXY | tojson }};
            data.PROXY.PROXY_URL = {{ config.PROXY.PROXY_URL | tojson }};
            
            // --- æ”¶é›† RULES æ•°ç»„ (ä¿®æ­£å…³é”®è¯å­—æ®µåä»¥åŒ¹é…åç«¯) ---
            const ruleBlocks = document.querySelectorAll('.rule-block');

            ruleBlocks.forEach(block => {
                const ruleData = {
                    name: block.querySelector('input[name$="[name]"]').value,
                    folder_prefix: block.querySelector('input[name$="[folder_prefix]"]').value,
                    
                    // âœ… å…³é”®è¯æ–‡æœ¬å­—æ®µï¼šä½¿ç”¨ _text åç¼€ï¼Œä»¥ä¾¿åç«¯ app.py è§£æå¤šè¡Œæ–‡æœ¬
                    priority_keywords_text: block.querySelector('textarea[name$="[priority_keywords]"]').value,
                    required_keywords_text: block.querySelector('textarea[name$="[required_keywords]"]').value, 
                    optional_keywords_text: block.querySelector('textarea[name$="[optional_keywords]"]').value,
                    excluded_keywords_text: block.querySelector('textarea[name$="[excluded_keywords]"]').value,
                    
                    try_join: block.querySelector('input[name$="[try_join]"]').checked
                };

                data.RULES.API_CONFIGS.push(ruleData);
            });

            // æäº¤ AJAX è¯·æ±‚
            const result = await sendApiRequest('/api/config', 'POST', data);
            document.getElementById('status').innerHTML = result.message + (result.success ? '' : `<br>è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ã€‚`);
            
            if (result.success) { setTimeout(() => location.reload(), 500); }
        });

        // --- ç›‘æ§ç®¡ç†å‡½æ•° ---
        async function startMonitor() {
            const result = await sendApiRequest('/api/monitor/start', 'POST');
            document.getElementById('status').textContent = result.message;
            if (result.success) { setTimeout(() => location.reload(), 1000); }
        }

        async function stopMonitor() {
            const result = await sendApiRequest('/api/monitor/stop', 'POST');
            document.getElementById('status').textContent = result.message;
            if (result.success) { setTimeout(() => location.reload(), 1000); }
        }
    </script>
</body>
</html>
